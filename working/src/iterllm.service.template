[Unit]
Description=IterLLM Runtime Service
After=network-online.target

[Service]
EnvironmentFile=%h/.config/iterllm/%p.env

# --- Security & Isolation ---
Type=exec
PrivateMounts=yes
PrivateTmp=yes
ProtectSystem=full
NoNewPrivileges=yes
Delegate=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictSUIDSGID=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes

# --- Credentials ---
# Decrypts %h/.config/credstore.encrypted/my_api_key -> $CREDENTIALS_DIRECTORY/my_api_key
LoadCredentialEncrypted=my_api_key:%h/.config/credstore.encrypted/my_api_key

# --- Container Execution ---
# We run bash via /bin/sh to expand $CREDENTIALS_DIRECTORY before calling podman
ExecStart=/bin/sh -c '/usr/bin/podman run \
    --name $SERVICE_NAME \
    --replace \
    --rm \
    --cgroup-manager=systemd \
    --sdnotify=conmon \
    --network=slirp4netns \
    -v "$${CREDENTIALS_DIRECTORY}/$CRED_NAME:/run/secrets/$CRED_NAME:ro" \
    $RUNTIME_IMAGE:latest \
    /bin/bash -c "echo Service Started; if [ -f /run/secrets/$CRED_NAME ]; then echo Key available at /run/secrets/$CRED_NAME; else echo Key missing; fi; sleep infinity"'

# Cleanup
ExecStop=/usr/bin/podman stop --ignore --time 10 $SERVICE_NAME
ExecStopPost=/usr/bin/podman rm --force --ignore $SERVICE_NAME

[Install]
WantedBy=default.target
